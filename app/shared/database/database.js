"use strict";
var core_1 = require("@angular/core");
var nativescript_couchbase_1 = require("nativescript-couchbase");
// var couchbaseModule = require("nativescript-couchbase");
var Database = (function () {
    function Database() {
        this.eventList = [];
        this.lookupDocumentKey = "events"; //defining keys for database, should never change
        console.log("Database: constructor()");
        this.eventDatabase = new nativescript_couchbase_1.Couchbase("event_db"); //initalizing Database
        this.lookupDatabase = new nativescript_couchbase_1.Couchbase("lookup_db"); //initalizing Database
        this.lookupDocument = this.lookupDatabase.getDocument(this.lookupDocumentKey); //creating single document with unchanging key
        var lookupDoc = {
            index: "-1",
            number_of_events: "-1"
        };
        if (!this.lookupDocument) {
            this.lookupDatabase.createDocument(lookupDoc, this.lookupDocumentKey);
            console.log("initalizing lookupDocument: " + this.lookupDocument);
        }
        this.updateList();
        // this.reset();
    }
    // updateDocument(key, data)
    // createDocument(data, key)
    // event = { //createing event and storeing it's key inside
    //         key: numOfEvents,
    //         title: title,
    //         description: description,
    //         priority: priority,
    //         startTime: startTime,
    //         endTime: endTime
    //     };
    Database.prototype.deleteEvent = function (key) {
        this.eventDatabase.deleteDocument(key);
        var number_of_eventNew = this.lookupDatabase.getDocument(this.lookupDocumentKey).number_of_events;
        var indexCurrentNew = this.lookupDatabase.getDocument(this.lookupDocumentKey).index;
        number_of_eventNew = String((Number(number_of_eventNew) - 1));
        indexCurrentNew = String((Number(indexCurrentNew) - 1));
        this.lookupDatabase.updateDocument(this.lookupDocumentKey, {
            index: indexCurrentNew,
            number_of_events: number_of_eventNew
        });
        this.eventList[key] = this.eventList[this.eventList.length - 1];
        this.eventList[this.eventList.length - 1] = null;
    };
    Database.prototype.reset = function () {
        var index = this.lookupDatabase.getDocument(this.lookupDocumentKey).number_of_events;
        index = Number(index);
        for (var t = 0; t < index; t++) {
            var eventKeys = String(t);
            this.eventDatabase.deleteDocument(eventKeys);
        }
        this.lookupDatabase.updateDocument(this.lookupDocumentKey, {
            index: "-1",
            number_of_events: "-1"
        });
        this.eventList = [];
        console.log("DB RESET");
    };
    Database.prototype.editEvent = function (key, title, description, priority, startTime, endTime, icon) {
        this.eventDatabase.updateDocument(key, {
            key: key,
            title: title,
            description: description,
            priority: priority,
            startTimeHour: startTime.getHours(),
            startTimeMinute: startTime.getMinutes(),
            endTimeHour: endTime.getHours(),
            endTimeMinute: endTime.getMinutes(),
            icon: icon
        });
        this.updateList();
    };
    Database.prototype.newEvent = function (title, description, priority, startTime, endTime, icon) {
        var numOfEvents = this.lookupDatabase.getDocument(this.lookupDocumentKey).index;
        numOfEvents = Number(numOfEvents);
        var adjustedNumEvents = numOfEvents + 2;
        adjustedNumEvents = String(adjustedNumEvents);
        numOfEvents += 1;
        numOfEvents = String(numOfEvents);
        // let startTimeStr = startTime.getHours() + "." + startTime.getMinutes();
        // let endTimeStr = endTime.getHours() + "." + endTime.getMinutes();
        var event = {
            key: numOfEvents,
            title: title,
            description: description,
            priority: priority,
            startTimeHour: startTime.getHours(),
            startTimeMinute: startTime.getMinutes(),
            endTimeHour: endTime.getHours(),
            endTimeMinute: endTime.getMinutes(),
            icon: icon
        };
        this.eventDatabase.createDocument(event, numOfEvents);
        this.lookupDatabase.updateDocument(this.lookupDocumentKey, {
            index: numOfEvents,
            number_of_events: adjustedNumEvents
        });
        this.updateList();
    }; //end of newEvent
    Database.prototype.updateList = function () {
        var index = this.lookupDatabase.getDocument(this.lookupDocumentKey).number_of_events;
        index = Number(index);
        for (var t = 0; t < index; t++) {
            var eventKeys = String(t);
            this.eventList[t] = (this.eventDatabase.getDocument(eventKeys));
        }
    }; //end of updateList
    Database.prototype.getEventList = function () {
        return this.eventList;
    };
    Database = __decorate([
        core_1.Injectable(), 
        __metadata('design:paramtypes', [])
    ], Database);
    return Database;
}());
exports.Database = Database;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YWJhc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkYXRhYmFzZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEscUJBQXdELGVBQWUsQ0FBQyxDQUFBO0FBR3hFLHVDQUEwQix3QkFBd0IsQ0FBQyxDQUFBO0FBQ25ELDJEQUEyRDtBQUczRDtJQVdJO1FBVFEsY0FBUyxHQUFHLEVBQUUsQ0FBQztRQU9mLHNCQUFpQixHQUFXLFFBQVEsQ0FBQyxDQUFDLGlEQUFpRDtRQUczRixPQUFPLENBQUMsR0FBRyxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLGtDQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxzQkFBc0I7UUFDdEUsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLGtDQUFTLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxzQkFBc0I7UUFFeEUsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLDhDQUE4QztRQUc3SCxJQUFJLFNBQVMsR0FBRztZQUNaLEtBQUssRUFBRSxJQUFJO1lBQ1gsZ0JBQWdCLEVBQUUsSUFBSTtTQUN6QixDQUFDO1FBRUYsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztZQUN2QixJQUFJLENBQUMsY0FBYyxDQUFDLGNBQWMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFDdEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDdEUsQ0FBQztRQUNELElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNsQixnQkFBZ0I7SUFDcEIsQ0FBQztJQUNELDRCQUE0QjtJQUM1Qiw0QkFBNEI7SUFFNUIsMkRBQTJEO0lBQzNELDRCQUE0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QVUsR0FBakI7UUFDSSxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxnQkFBZ0IsQ0FBQTtRQUNwRixLQUFLLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3RCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDN0IsSUFBSSxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7SUFDTCxDQUFDLEVBQUEsbUJBQW1CO0lBRWIsK0JBQVksR0FBbkI7UUFDSSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBN0lMO1FBQUMsaUJBQVUsRUFBRTs7Z0JBQUE7SUE4SWIsZUFBQztBQUFELENBQUMsQUE3SUQsSUE2SUM7QUE3SVksZ0JBQVEsV0E2SXBCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBJbnB1dCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBFdmVudEhhbmRlbGVyIH0gZnJvbSBcIi4uL3Byb3ZpZGVycy9ldmVudC1oYW5kZWxlci9ldmVudC1oYW5kZWxlci5wcm92aWRlclwiO1xyXG5pbXBvcnQgeyBFdmVudFByb3ZpZGVyIH0gZnJvbSBcIi4uL3Byb3ZpZGVycy9ldmVudC9ldmVudC5wcm92aWRlclwiO1xyXG5pbXBvcnQgeyBDb3VjaGJhc2UgfSBmcm9tIFwibmF0aXZlc2NyaXB0LWNvdWNoYmFzZVwiO1xyXG4vLyB2YXIgY291Y2hiYXNlTW9kdWxlID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC1jb3VjaGJhc2VcIik7XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBEYXRhYmFzZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBldmVudExpc3QgPSBbXTtcclxuXHJcbiAgICBwcml2YXRlIGV2ZW50RGF0YWJhc2U6IGFueTsgLy9EYXRhYmFzZVxyXG4gICAgcHJpdmF0ZSBsb29rdXBEYXRhYmFzZTogYW55OyAvL0RhdGFiYXNlXHJcblxyXG4gICAgcHJpdmF0ZSBsb29rdXBEb2N1bWVudDogYW55OyAvL0RvY3VtZW50OiBjb250YWlucyB0aGUgY3VycmVudCBpbmRleCBvZiBldmVudHNcclxuXHJcbiAgICBwcml2YXRlIGxvb2t1cERvY3VtZW50S2V5OiBzdHJpbmcgPSBcImV2ZW50c1wiOyAvL2RlZmluaW5nIGtleXMgZm9yIGRhdGFiYXNlLCBzaG91bGQgbmV2ZXIgY2hhbmdlXHJcblxyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJEYXRhYmFzZTogY29uc3RydWN0b3IoKVwiKTtcclxuICAgICAgICB0aGlzLmV2ZW50RGF0YWJhc2UgPSBuZXcgQ291Y2hiYXNlKFwiZXZlbnRfZGJcIik7IC8vaW5pdGFsaXppbmcgRGF0YWJhc2VcclxuICAgICAgICB0aGlzLmxvb2t1cERhdGFiYXNlID0gbmV3IENvdWNoYmFzZShcImxvb2t1cF9kYlwiKTsgLy9pbml0YWxpemluZyBEYXRhYmFzZVxyXG5cclxuICAgICAgICB0aGlzLmxvb2t1cERvY3VtZW50ID0gdGhpcy5sb29rdXBEYXRhYmFzZS5nZXREb2N1bWVudCh0aGlzLmxvb2t1cERvY3VtZW50S2V5KTsgLy9jcmVhdGluZyBzaW5nbGUgZG9jdW1lbnQgd2l0aCB1bmNoYW5naW5nIGtleVxyXG5cclxuXHJcbiAgICAgICAgbGV0IGxvb2t1cERvYyA9IHtcclxuICAgICAgICAgICAgaW5kZXg6IFwiLTFcIixcclxuICAgICAgICAgICAgbnVtYmVyX29mX2V2ZW50czogXCItMVwiXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmxvb2t1cERvY3VtZW50KSB7IC8vaW5pdGFsaXppbmcgZG9jdW1lbnQgaWYgZG9jdW1lbnQgZG9lcyBub3QgZXhpc3RcclxuICAgICAgICAgICAgdGhpcy5sb29rdXBEYXRhYmFzZS5jcmVhdGVEb2N1bWVudChsb29rdXBEb2MsIHRoaXMubG9va3VwRG9jdW1lbnRLZXkpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImluaXRhbGl6aW5nIGxvb2t1cERvY3VtZW50OiBcIiArIHRoaXMubG9va3VwRG9jdW1lbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnVwZGF0ZUxpc3QoKTtcclxuICAgICAgICAvLyB0aGlzLnJlc2V0KCk7XHJcbiAgICB9XHJcbiAgICAvLyB1cGRhdGVEb2N1bWVudChrZXksIGRhdGEpXHJcbiAgICAvLyBjcmVhdGVEb2N1bWVudChkYXRhLCBrZXkpXHJcblxyXG4gICAgLy8gZXZlbnQgPSB7IC8vY3JlYXRlaW5nIGV2ZW50IGFuZCBzdG9yZWluZyBpdCdzIGtleSBpbnNpZGVcclxuICAgIC8vICAgICAgICAga2V5OiBudW1PZkV2ZW50cyxcclxuICAgIC8vICAgICAgICAgdGl0bGU6IHRpdGxlLFxyXG4gICAgLy8gICAgICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24sXHJcbiAgICAvLyAgICAgICAgIHByaW9yaXR5OiBwcmlvcml0eSxcclxuICAgIC8vICAgICAgICAgc3RhcnRUaW1lOiBzdGFydFRpbWUsXHJcbiAgICAvLyAgICAgICAgIGVuZFRpbWU6IGVuZFRpbWVcclxuICAgIC8vICAgICB9O1xyXG5cclxuXHJcbiAgICBwdWJsaWMgZGVsZXRlRXZlbnQoa2V5OiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLmV2ZW50RGF0YWJhc2UuZGVsZXRlRG9jdW1lbnQoa2V5KTtcclxuXHJcbiAgICAgICAgbGV0IG51bWJlcl9vZl9ldmVudE5ldyA9IHRoaXMubG9va3VwRGF0YWJhc2UuZ2V0RG9jdW1lbnQodGhpcy5sb29rdXBEb2N1bWVudEtleSkubnVtYmVyX29mX2V2ZW50cztcclxuICAgICAgICBsZXQgaW5kZXhDdXJyZW50TmV3ID0gdGhpcy5sb29rdXBEYXRhYmFzZS5nZXREb2N1bWVudCh0aGlzLmxvb2t1cERvY3VtZW50S2V5KS5pbmRleDtcclxuXHJcbiAgICAgICAgbnVtYmVyX29mX2V2ZW50TmV3ID0gU3RyaW5nKChOdW1iZXIobnVtYmVyX29mX2V2ZW50TmV3KS0xKSk7XHJcbiAgICAgICAgaW5kZXhDdXJyZW50TmV3ID0gU3RyaW5nKChOdW1iZXIoaW5kZXhDdXJyZW50TmV3KS0xKSk7XHJcblxyXG4gICAgICAgIHRoaXMubG9va3VwRGF0YWJhc2UudXBkYXRlRG9jdW1lbnQodGhpcy5sb29rdXBEb2N1bWVudEtleSwge1xyXG4gICAgICAgICAgICBpbmRleDogaW5kZXhDdXJyZW50TmV3LFxyXG4gICAgICAgICAgICBudW1iZXJfb2ZfZXZlbnRzOiBudW1iZXJfb2ZfZXZlbnROZXdcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmV2ZW50TGlzdFtrZXldID0gdGhpcy5ldmVudExpc3RbdGhpcy5ldmVudExpc3QubGVuZ3RoLTFdO1xyXG4gICAgICAgIHRoaXMuZXZlbnRMaXN0W3RoaXMuZXZlbnRMaXN0Lmxlbmd0aC0xXSA9IG51bGw7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHB1YmxpYyByZXNldCgpIHtcclxuXHJcbiAgICAgICAgbGV0IGluZGV4ID0gdGhpcy5sb29rdXBEYXRhYmFzZS5nZXREb2N1bWVudCh0aGlzLmxvb2t1cERvY3VtZW50S2V5KS5udW1iZXJfb2ZfZXZlbnRzXHJcbiAgICAgICAgaW5kZXggPSBOdW1iZXIoaW5kZXgpO1xyXG4gICAgICAgIGZvciAobGV0IHQgPSAwOyB0IDwgaW5kZXg7IHQrKykge1xyXG4gICAgICAgICAgICBsZXQgZXZlbnRLZXlzID0gU3RyaW5nKHQpO1xyXG4gICAgICAgICAgICB0aGlzLmV2ZW50RGF0YWJhc2UuZGVsZXRlRG9jdW1lbnQoZXZlbnRLZXlzKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMubG9va3VwRGF0YWJhc2UudXBkYXRlRG9jdW1lbnQodGhpcy5sb29rdXBEb2N1bWVudEtleSwge1xyXG4gICAgICAgICAgICBpbmRleDogXCItMVwiLFxyXG4gICAgICAgICAgICBudW1iZXJfb2ZfZXZlbnRzOiBcIi0xXCJcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLmV2ZW50TGlzdCA9IFtdO1xyXG5cclxuICAgICAgICBjb25zb2xlLmxvZyhcIkRCIFJFU0VUXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBlZGl0RXZlbnQoa2V5OiBzdHJpbmcsIHRpdGxlOiBzdHJpbmcsIGRlc2NyaXB0aW9uOiBzdHJpbmcsIHByaW9yaXR5OiBudW1iZXIsIHN0YXJ0VGltZTogRGF0ZSwgZW5kVGltZTogRGF0ZSwgaWNvbjpudW1iZXIpIHtcclxuICAgICAgICB0aGlzLmV2ZW50RGF0YWJhc2UudXBkYXRlRG9jdW1lbnQoa2V5LCB7XHJcbiAgICAgICAgICAgIGtleToga2V5LFxyXG4gICAgICAgICAgICB0aXRsZTogdGl0bGUsXHJcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgcHJpb3JpdHk6IHByaW9yaXR5LFxyXG4gICAgICAgICAgIHN0YXJ0VGltZUhvdXI6IHN0YXJ0VGltZS5nZXRIb3VycygpLFxyXG4gICAgICAgICAgICBzdGFydFRpbWVNaW51dGU6IHN0YXJ0VGltZS5nZXRNaW51dGVzKCksXHJcbiAgICAgICAgICAgIGVuZFRpbWVIb3VyOiBlbmRUaW1lLmdldEhvdXJzKCksXHJcbiAgICAgICAgICAgIGVuZFRpbWVNaW51dGU6IGVuZFRpbWUuZ2V0TWludXRlcygpLFxyXG4gICAgICAgICAgICBpY29uOiBpY29uXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVMaXN0KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG5ld0V2ZW50KHRpdGxlOiBzdHJpbmcsIGRlc2NyaXB0aW9uOiBzdHJpbmcsIHByaW9yaXR5OiBudW1iZXIsIHN0YXJ0VGltZTogRGF0ZSwgZW5kVGltZTogRGF0ZSwgaWNvbjogbnVtYmVyKSB7XHJcblxyXG4gICAgICAgIGxldCBudW1PZkV2ZW50cyA9IHRoaXMubG9va3VwRGF0YWJhc2UuZ2V0RG9jdW1lbnQodGhpcy5sb29rdXBEb2N1bWVudEtleSkuaW5kZXg7XHJcbiAgICAgICAgbnVtT2ZFdmVudHMgPSBOdW1iZXIobnVtT2ZFdmVudHMpO1xyXG5cclxuICAgICAgICBsZXQgYWRqdXN0ZWROdW1FdmVudHMgPSBudW1PZkV2ZW50cyArIDI7XHJcblxyXG4gICAgICAgIGFkanVzdGVkTnVtRXZlbnRzID0gU3RyaW5nKGFkanVzdGVkTnVtRXZlbnRzKTtcclxuXHJcbiAgICAgICAgbnVtT2ZFdmVudHMgKz0gMTtcclxuICAgICAgICBudW1PZkV2ZW50cyA9IFN0cmluZyhudW1PZkV2ZW50cyk7XHJcblxyXG4gICAgICAgIC8vIGxldCBzdGFydFRpbWVTdHIgPSBzdGFydFRpbWUuZ2V0SG91cnMoKSArIFwiLlwiICsgc3RhcnRUaW1lLmdldE1pbnV0ZXMoKTtcclxuICAgICAgICAvLyBsZXQgZW5kVGltZVN0ciA9IGVuZFRpbWUuZ2V0SG91cnMoKSArIFwiLlwiICsgZW5kVGltZS5nZXRNaW51dGVzKCk7XHJcblxyXG4gICAgICAgIGxldCBldmVudCA9IHsgLy9jcmVhdGVpbmcgZXZlbnQgYW5kIHN0b3JlaW5nIGl0J3Mga2V5IGluc2lkZVxyXG4gICAgICAgICAgICBrZXk6IG51bU9mRXZlbnRzLFxyXG4gICAgICAgICAgICB0aXRsZTogdGl0bGUsXHJcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbixcclxuICAgICAgICAgICAgcHJpb3JpdHk6IHByaW9yaXR5LFxyXG4gICAgICAgICAgICBzdGFydFRpbWVIb3VyOiBzdGFydFRpbWUuZ2V0SG91cnMoKSxcclxuICAgICAgICAgICAgc3RhcnRUaW1lTWludXRlOiBzdGFydFRpbWUuZ2V0TWludXRlcygpLFxyXG4gICAgICAgICAgICBlbmRUaW1lSG91cjogZW5kVGltZS5nZXRIb3VycygpLFxyXG4gICAgICAgICAgICBlbmRUaW1lTWludXRlOiBlbmRUaW1lLmdldE1pbnV0ZXMoKSxcclxuICAgICAgICAgICAgaWNvbjogaWNvblxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIHRoaXMuZXZlbnREYXRhYmFzZS5jcmVhdGVEb2N1bWVudChldmVudCwgbnVtT2ZFdmVudHMpO1xyXG4gICAgICAgIHRoaXMubG9va3VwRGF0YWJhc2UudXBkYXRlRG9jdW1lbnQodGhpcy5sb29rdXBEb2N1bWVudEtleSwge1xyXG4gICAgICAgICAgICBpbmRleDogbnVtT2ZFdmVudHMsXHJcbiAgICAgICAgICAgIG51bWJlcl9vZl9ldmVudHM6IGFkanVzdGVkTnVtRXZlbnRzXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy51cGRhdGVMaXN0KCk7XHJcbiAgICB9Ly9lbmQgb2YgbmV3RXZlbnRcclxuXHJcbiAgICBwdWJsaWMgdXBkYXRlTGlzdCgpIHtcclxuICAgICAgICBsZXQgaW5kZXggPSB0aGlzLmxvb2t1cERhdGFiYXNlLmdldERvY3VtZW50KHRoaXMubG9va3VwRG9jdW1lbnRLZXkpLm51bWJlcl9vZl9ldmVudHNcclxuICAgICAgICBpbmRleCA9IE51bWJlcihpbmRleCk7XHJcbiAgICAgICAgZm9yIChsZXQgdCA9IDA7IHQgPCBpbmRleDsgdCsrKSB7XHJcbiAgICAgICAgICAgIGxldCBldmVudEtleXMgPSBTdHJpbmcodCk7XHJcbiAgICAgICAgICAgIHRoaXMuZXZlbnRMaXN0W3RdID0gKHRoaXMuZXZlbnREYXRhYmFzZS5nZXREb2N1bWVudChldmVudEtleXMpKTtcclxuICAgICAgICB9XHJcbiAgICB9Ly9lbmQgb2YgdXBkYXRlTGlzdFxyXG5cclxuICAgIHB1YmxpYyBnZXRFdmVudExpc3QoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZXZlbnRMaXN0O1xyXG4gICAgfVxyXG59Il19